#!/bin/sh

set -e

case "$1" in
  "--help"|"-h"|"")
    echo "Usage: $0 {container-name|--rm} image-name cmd..." >&2
    exit 1
    ;;
esac

image="/var/cookie-cutter/images/$2"
container_name="$1"
if [ "x$container_name" = "x--rm" ]; then
  container_name="tmp.$$"
  remove=1
fi
container="/var/cookie-cutter/containers/$container_name"
shift 2

(
  trap "echo Cleaning up... >&2; rm -rf '$container.$$'" \
    INT TERM HUP EXIT
  cp -a "$image" "$container.$$"
  echo "$container_name" > "$container.$$"/etc/debian_chroot
  mv "$container.$$" "$container"
) 

if [ "$remove" = "1" ]; then
  trap "echo Cleaning up... >&2; rm -rf '$container'" \
    INT TERM HUP EXIT
fi


my_dir="`dirname $0`"
"$my_dir"/cc-run "$container_name" "$@"
