#!/bin/sh

set -e

case "$1" in
  "--help"|"-h"|"")
    echo "Usage: $0 output-image-name spec-file source-dir" >&2
    exit 1
    ;;
esac

name="$1"
spec="$2"
source="$3"

build_dir="/var/cookie-cutter/containers/build.$$"
image_base="/var/cookie-cutter/images/$name"

trap "rm -rf $build_dir $image_base.$$" \
  INT TERM HUP EXIT

my_dir="`dirname $0`"

while read cmd arg1 arg2 rest; do
  case "$cmd" in
    FROM)
      from_name="$arg1"
     "$my_dir"/cc-create "build.$$" "$from_name"
      ;;
    COPY)
      cp -r "$source/$arg1" "$build_dir/filesystem/$arg2"
      ;;
    RUN)
      #echo arg1="$arg1"
      #echo arg2="$arg2"
      #echo rest="$rest"
      "$my_dir"/cc-run "build.$$" sh -c "$arg1 $arg2 $rest"
      ;;
    "#")
      # skip comment line, provided there is a space after the "#"
      ;;
    "")
      # skip blank line
      ;;
    *)
      echo "Unknown command: '$cmd'" >&2
  esac
done < "$spec"

"$my_dir"/cc-umount "build.$$"

mkdir "$image_base.$$"
mv "$build_dir/diff" "$image_base.$$/diff"
mv "$build_dir/from" "$image_base.$$/from"
rm -rf "$image_base"
mv "$image_base.$$" "$image_base"
