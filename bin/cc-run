#!/bin/sh

set -e

case "$1" in
  "--help"|"-h"|"")
    echo "Usage: $0 [options] image-name cmd..." >&2
    echo "" >&2
    echo "  --name container_name" >&2
    echo "      Give the container a name to refer to with cc-exec" >&2
    echo "      or to ensure only one such container on the system." >&2
    echo "" >&2
    echo "  --rm" >&2
    echo "      Automatically remove the container on exit." >&2
    echo "      Implied when no '--name' option is given." >&2
    echo "" >&2
    echo "  -v|--volume host-path:container-path" >&2
    echo "      Bind-mount host-path on the host VM as container-path" >&2
    echo "      within the guest container." >&2
    exit 1
    ;;
esac

my_dir="`dirname $0`"
container_name="$("$my_dir"/cc-create "$@")"

while [ -n "$1" ]; do
  case "$1" in
    "--volume"|"-v")
      shift 2
      ;;
    "--name")
      named=1
      shift 2
      ;;
    "--rm")
      remove=1
      shift
      ;;
    "-"*)
      # Ignore options (such as --name, used by cc-create).
      shift
      ;;
    *)
      break; # end of option args
      ;;
  esac
done

if [ "$named" = "" ]; then
  remove=1
fi

image_name="$1"
shift 1
image="/var/cookie-cutter/images/$image_name"

container="/var/cookie-cutter/containers/$container_name"
echo "$container_name" > "$container"/filesystem/etc/debian_chroot

cleanup="
  #echo Cleaning up... >&2
  mntuser () { fuser --ismountpoint --mount \"\$@\" '$container/filesystem'; }
  if ! mntuser --silent 2>&1 | grep -q 'is not a mountpoint' &&
     mntuser --silent --kill -TERM; then
    echo -n 'Sent SIGTERM.  Waiting for processes to stop '
    for i in \`seq 1 100\`; do
      echo -n .
      mntuser --silent || { echo; break; }
      sleep 0.1
      if [ \$i = 100 ]; then
        echo
        mntuser --verbose
        echo Sending SIGKILL.
        mntuser --silent --kill -KILL
      fi
    done
  fi
  '$my_dir'/cc-umount '$container_name'
"
if [ "$remove" = "1" ]; then
  cleanup="
    $cleanup
    rm -rf --one-file-system '$container'
  "
fi
trap "$cleanup" INT TERM HUP EXIT

"$my_dir"/cc-exec "$container_name" "$@"
